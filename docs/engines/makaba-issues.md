# makaba

While adding support for `2ch.hk` some very minor bugs have been discovered in the `makaba` engine (as of June 2019).

* Incorrect `files_count` property both `/catalog.json` API response and "get thread" API response. For example, for a thread having only one reply with 4 attachments in it `files_count` will be `1` in `/catalog.json` API response and `2` in "get thread" API response. For `/catalog.json` API response it seems to count "replies having attachments" instead of "attachments in replies having attachments", and for "get thread" API response it seems to do the same thing while also counting the attachments of the opening post (which should be skipped).

* `unique_posters` doesn't include the "original post" of a thread: it won't count thread author unless they've posted a comment in their own thread.

* (has a hacky workaround) A request to get an archived thread's JSON results in a `404 Not Found` error. Example: `https://2ch.hk/b/res/119034529.json`. The code manually detects such "Not found" errors to resend the request to get the archived thread's JSON with the `/arch/` URL prefix. Example: `https://2ch.hk/b/arch/res/119034529.json`. This URL gets redirected to something like: `https://2ch.hk/b/arch/2016-03-06/res/119034529.json`. Then, the code employs another hack to get the "final" URL (after the redirect), and then it extracts the `2016-03-06` date from it. Aside from being the general info, the archived date is also required in order to transform relative image URLs to absolute ones for really old threads between `2016-03-06` and `2016-11-12`. Example: `thumb/119034529/14572604256670s.jpg` -> `https://2ch.hk/b/arch/2016-03-06/thumb/119034529/14572604256670s.jpg`.